<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Python,WEB,框架,Tornado," />








  <link rel="shortcut icon" type="image/x-icon" href="/img/touxiang.jpg?v=5.1.0" />






<meta name="description" content="人生苦短,我玩Python">
<meta name="keywords" content="Python,WEB,框架,Tornado">
<meta property="og:type" content="article">
<meta property="og:title" content="玩蛇笔记WEB篇之Tornado">
<meta property="og:url" content="https://TakeEasy.github.io/2017/07/06/玩蛇笔记WEB篇之Tornado/index.html">
<meta property="og:site_name" content="YEAR&#39;s Blog">
<meta property="og:description" content="人生苦短,我玩Python">
<meta property="og:image" content="https://takeeasy.github.io/img/12.png">
<meta property="og:updated_time" content="2017-08-09T06:38:02.787Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="玩蛇笔记WEB篇之Tornado">
<meta name="twitter:description" content="人生苦短,我玩Python">
<meta name="twitter:image" content="https://takeeasy.github.io/img/12.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://TakeEasy.github.io/2017/07/06/玩蛇笔记WEB篇之Tornado/"/>





  <title> 玩蛇笔记WEB篇之Tornado | YEAR's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YEAR's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">~~~~~</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://TakeEasy.github.io/2017/07/06/玩蛇笔记WEB篇之Tornado/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YEAR">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YEAR's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                玩蛇笔记WEB篇之Tornado
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-06T19:57:06+08:00">
                2017-07-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/Python/WEB/" itemprop="url" rel="index">
                    <span itemprop="name">WEB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/06/玩蛇笔记WEB篇之Tornado/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/06/玩蛇笔记WEB篇之Tornado/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/06/玩蛇笔记WEB篇之Tornado/" class="leancloud_visitors" data-flag-title="玩蛇笔记WEB篇之Tornado">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote class="blockquote-center"><p>人生苦短,我玩Python </p>
</blockquote>
<span itemprop="image" itemscope="" itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="/img/12.png" class="full-image" alt="..." title="Python"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span>
<a id="more"></a>
<blockquote>
<p>Python WEB框架 先来Tornado吧…<br>2017-07-06:更新 概述,框架使用中的快速开始.</p>
</blockquote>
<hr>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Tornado 是 FriendFeed 使用的可扩展的非阻塞式 web 服务器及其相关工具的开源版本.这个 Web 框架看起来有些像web.py 或者 Google 的 webapp，不过为了能有效利用非阻塞式服务器环境，这个 Web 框架还包含了一些相关的有用工具 和优化.</p>
<p>Tornado 和现在的主流 Web 服务器框架(包括大多数 Python 的框架)有着明显的区别:它是非阻塞式服务器.而且速度相当快。得利于其 非阻塞的方式和对 epoll 的运用.Tornado 每秒可以处理数以千计的连接.这意味着对于实时 Web 服务来说，Tornado 是一个理想的 Web 框架.<br><figure class="highlight plain"><figcaption><span>下载安装</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pip3 install tornado</div><div class="line">或者用源码安装,官网下载tar包.</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="框架使用"><a href="#框架使用" class="headerlink" title="框架使用"></a>框架使用</h3><h4 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h4><p><strong>下面所有的例子都基于此为基础,无非是添加Handler和路由索引.</strong><br><figure class="highlight python"><figcaption><span>start_simple.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment"># Author:YEAR</span></div><div class="line"><span class="keyword">import</span> tornado.ioloop</div><div class="line"><span class="keyword">import</span> tornado.web</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        self.write(<span class="string">"Hello,world"</span>)</div><div class="line"></div><div class="line">application=tornado.web.Application([</div><div class="line">    (<span class="string">r"/index"</span>,MainHandler)</div><div class="line">])</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</div><div class="line">    application.listen(<span class="number">8888</span>)</div><div class="line">    tornado.ioloop.IOLoop.instance().start()</div><div class="line"></div></pre></td></tr></table></figure><br>整个过程:</p>
<ol>
<li>执行py,监听本地8888端口</li>
<li>浏览器客户端访问本地8888端口/index目录–<a href="http://127.0.0.1:8888/index" target="_blank" rel="external">http://127.0.0.1:8888/index</a></li>
<li>服务器接收请求,有application里的正则表达式解析地址,选择对应对的Handler类操作.</li>
<li>类接收到请求后,根据请求方法(post/get/delete…)执行对应的函数.</li>
<li>方法返回的值返回给请求客户端上</li>
</ol>
<h4 id="路由系统"><a href="#路由系统" class="headerlink" title="路由系统"></a>路由系统</h4><p>所谓路由系统,就是一种寻址方式,就是根据用户请求的网址,来知道用户想要做什么或者需要得到什么样的信息.<br><figure class="highlight python"><figcaption><span>route.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">application = tornado.web.Application([</div><div class="line">    (<span class="string">r"/index"</span>, MainHandler),</div><div class="line">    (<span class="string">r"/demo"</span>, demoHandler),</div><div class="line">    (<span class="string">r"/login"</span>, loginHandler),</div><div class="line">    (<span class="string">r"/logout"</span>, logoutHandler),</div><div class="line">    (<span class="string">r"/publish"</span>, publishHandler),</div><div class="line">    (<span class="string">r"/page/(?P&lt;page&gt;\d*)"</span>, pageHandler),  <span class="comment"># 正则表达式索引</span></div><div class="line">    (<span class="string">r"/extendInclude"</span>, eandiHandler),</div><div class="line">    (<span class="string">r"/cookie"</span>, cookieHandler),</div><div class="line">    (<span class="string">r"/cookielogin"</span>, cookieloginHandler),</div><div class="line">    (<span class="string">r"/session"</span>, sessionHandler),</div><div class="line">    (<span class="string">r"/sessionlogin"</span>, sessionloginHandler),</div><div class="line">    (<span class="string">r"/checkcode"</span>, checkcodeHandler),</div><div class="line">    (<span class="string">r"/checkcodeLogin"</span>, checkcodeLoginHandler),  <span class="comment"># 带验证码登录的入口</span></div><div class="line">    (<span class="string">r"/csrf"</span>, csrfHandler),</div><div class="line">    (<span class="string">r"/ajax"</span>, ajaxHandler),</div><div class="line">    (<span class="string">r"/fileupload"</span>,fileuploadHandler),</div><div class="line">    (<span class="string">r"/corsAjax"</span>,corsAJAXHandler),</div><div class="line">    (<span class="string">r"/checkform"</span>,checkFormHandler),</div><div class="line">], **settings)</div><div class="line"></div><div class="line">application.add_handlers(<span class="string">'biubiu.year.cool$'</span>, [</div><div class="line">    (<span class="string">r'/index'</span>, demoHandler)</div><div class="line">])</div></pre></td></tr></table></figure><br>我们在创建tornado的application对象的时候就需要给定一个路由系统的对应列表,列表元素是一个包含地址内容和Handler类的元组.<br>Tornado中原生支持二级域名的路由.</p>
<h4 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h4><p>Tornado的模板引擎和Django中类似,模板引擎将模板文件载入内存,然后根据模板引擎中的模板语言和加载时传入的数据生成最终的字符串返回给请求用户,实际上跟大多数的模板引擎类似,只是模板语法不同.像JSP,ASP原理基本一样.<br>Tornado的模板语言主要有<strong>控制语句</strong>和<strong>表达语句</strong>,控制语句使用<code>{%</code>和<code>%}</code>包起来类似<code>{% if len(items) > 2 %}</code>.表达语句是使用<code>{{</code> 和 <code>}}</code>包起来类似<code>{{ items[0] }}</code><br>控制语句和对应的Python语句的格式几乎完全相同,支持<code>for</code>,<code>while</code>,<code>if</code>,<code>try</code>只不过在逻辑结束的时候要加上<code>{% end %}</code>,还通过<code>extends</code>和<code>block</code>实现模板继承.<br>在使用模板引擎前需要在setting中设置模板文件的路径.</p>
<ol>
<li><p>基本  </p>
 <figure class="highlight python"><figcaption><span>app.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, id1, id2)</span>:</span></div><div class="line">        <span class="comment"># self.write("Hello,world")</span></div><div class="line">        name = self.get_argument(<span class="string">"yoyo"</span>, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> name:</div><div class="line">            INPUTS_LIST.append(name)</div><div class="line">        self.render(<span class="string">'index.html'</span>, yoyo=INPUTS_LIST, nmb=<span class="string">'biubiubiu'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        print(<span class="string">"post"</span>)</div><div class="line">        name = self.get_argument(<span class="string">"yoyo"</span>)</div><div class="line">        print(name)</div><div class="line">        INPUTS_LIST.append(name)</div><div class="line">        self.render(<span class="string">'index.html'</span>, yoyo=INPUTS_LIST, nmb=<span class="string">'biubiubiu'</span>)</div><div class="line"></div></pre></td></tr></table></figure>
 <figure class="highlight html"><figcaption><span>index.html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Tornado demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'&#123;&#123; static_url("jquery-3.2.0.min.js") &#125;&#125;'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">Hello,World!</div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/index"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"yoyo"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>内容展示<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123; func(nmb) &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;% module custom() %&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">        &#123;% for item in yoyo %&#125;</div><div class="line">            &#123;% if item=='baba' %&#125;</div><div class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">style</span>=<span class="string">"color:red"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">            &#123;% else %&#125;</div><div class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">            &#123;% end %&#125;</div><div class="line">        &#123;% end %&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure>
 <figure class="highlight plain"><figcaption><span>默提供的方法</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">escape: tornado.escape.xhtml_escape 的別名</div><div class="line">xhtml_escape: tornado.escape.xhtml_escape 的別名</div><div class="line">url_escape: tornado.escape.url_escape 的別名</div><div class="line">json_encode: tornado.escape.json_encode 的別名</div><div class="line">squeeze: tornado.escape.squeeze 的別名</div><div class="line">linkify: tornado.escape.linkify 的別名</div><div class="line">datetime: Python 的 datetime 模组</div><div class="line">handler: 当前的 RequestHandler 对象</div><div class="line">request: handler.request 的別名</div><div class="line">current_user: handler.current_user 的別名</div><div class="line">locale: handler.locale 的別名</div><div class="line">_: handler.locale.translate 的別名</div><div class="line">static_url: for handler.static_url 的別名</div><div class="line">xsrf_form_html: handler.xsrf_form_html 的別名</div><div class="line"></div></pre></td></tr></table></figure>
</li>
<li><p>使用母版文件的模板,以及导入别的文件内容的模板.</p>
 <figure class="highlight html"><figcaption><span>layout.html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">'&#123;&#123; static_url("bootstrap/css/bootstrap.css") &#125;&#125;'</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></div><div class="line">    &#123;% block css %&#125;&#123;% end %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    &#123;% block body %&#125;&#123;% end %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'&#123;&#123; static_url("jquery-3.2.0.min.js") &#125;&#125;'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'&#123;&#123; static_url("bootstrap/js/bootstrap.js") &#125;&#125;'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    &#123;% block js %&#125;&#123;% end %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure>
 <figure class="highlight html"><figcaption><span>form.html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">   </div><div class="line">   <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> /&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">   &#123;% endcodeblock %&#125;</div><div class="line">&#123;% codeblock lang:html eandi.html %&#125;</div><div class="line">   &#123;% extends './master/layout.html'  %&#125;</div><div class="line">   &#123;% block css %&#125;&#123;% end %&#125;</div><div class="line">   &#123;% block body %&#125;</div><div class="line">           &#123;% include './content/form.html' %&#125;&#123;% end %&#125;</div><div class="line">   &#123;% end %&#125;</div><div class="line">   &#123;% block js %&#125;&#123;% end %&#125;</div><div class="line">   </div><div class="line">   </div></pre></td></tr></table></figure>
</li>
<li><p>自定义UIMethod和UIIModule</p>
<ol>
<li><p>首先要定义它们</p>
 <figure class="highlight python"><figcaption><span>uimethods.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">       </div><div class="line">       <span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line">       <span class="comment"># Author:YEAR</span></div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self,arg)</span>:</span></div><div class="line">       <span class="keyword">return</span> <span class="string">"Hi"</span>+arg</div><div class="line">       &#123;% endcodeblock %&#125;</div><div class="line">&#123;% codeblock lang:python uimodule.py %&#125;</div><div class="line">       <span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line">       <span class="comment"># Author:YEAR</span></div><div class="line">       <span class="keyword">from</span> tornado.web <span class="keyword">import</span> UIModule</div><div class="line"></div><div class="line">       <span class="class"><span class="keyword">class</span> <span class="title">custom</span><span class="params">(UIModule)</span>:</span></div><div class="line">           <span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">               <span class="keyword">return</span> <span class="string">'123'</span></div><div class="line">       </div><div class="line">       </div></pre></td></tr></table></figure>
</li>
<li><p>要在settings中对他们进行注册</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">settings = &#123;</div><div class="line">    <span class="string">"template_path"</span>: <span class="string">"Template"</span>,  <span class="comment"># 模板路径的配置</span></div><div class="line">    <span class="string">"static_path"</span>: <span class="string">"Static"</span>,  <span class="comment"># 必须配置,否者静态文件永远找不到</span></div><div class="line">    <span class="string">"static_url_prefix"</span>: <span class="string">"/biubiu/"</span>,  <span class="comment"># 静态文件路径前缀</span></div><div class="line">    <span class="string">"ui_methods"</span>: md,  <span class="comment"># 配置ui method.</span></div><div class="line">    <span class="string">"ui_modules"</span>: mt,  <span class="comment"># 配置ui module.</span></div><div class="line">    <span class="string">"cookie_secret"</span>: <span class="string">'asdfasdfasdfasdfasdf'</span>,  <span class="comment"># cookie加密</span></div><div class="line">    <span class="string">"xsrf_cookies"</span>: <span class="keyword">True</span>  <span class="comment"># 跨站请求伪造防止</span></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
</li>
<li><p>在模板文件中使用它们</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Tornado demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'&#123;&#123; static_url("jquery-3.2.0.min.js") &#125;&#125;'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">Hello,World!</div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/index"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"yoyo"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>内容展示<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123; func(nmb) &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;% module custom() %&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">        &#123;% for item in yoyo %&#125;</div><div class="line">            &#123;% if item=='baba' %&#125;</div><div class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">style</span>=<span class="string">"color:red"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">            &#123;% else %&#125;</div><div class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">            &#123;% end %&#125;</div><div class="line">        &#123;% end %&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h4 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h4><p>对于静态文件的使用,主要是css,js,页面资源等等的使用,可以配置静态文件的系统目录和使用时的前缀,tornado支持静态文件的缓存<br><figure class="highlight python"><figcaption><span>settings.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">settings = &#123;</div><div class="line">    <span class="string">"template_path"</span>: <span class="string">"Template"</span>,  <span class="comment"># 模板路径的配置</span></div><div class="line">    <span class="string">"static_path"</span>: <span class="string">"Static"</span>,  <span class="comment"># 必须配置,否者静态文件永远找不到</span></div><div class="line">    <span class="string">"static_url_prefix"</span>: <span class="string">"/biubiu/"</span>,  <span class="comment"># 静态文件路径前缀</span></div><div class="line">    <span class="string">"ui_methods"</span>: md,  <span class="comment"># 配置ui method.</span></div><div class="line">    <span class="string">"ui_modules"</span>: mt,  <span class="comment"># 配置ui module.</span></div><div class="line">    <span class="string">"cookie_secret"</span>: <span class="string">'asdfasdfasdfasdfasdf'</span>,  <span class="comment"># cookie加密</span></div><div class="line">    <span class="string">"xsrf_cookies"</span>: <span class="keyword">True</span>  <span class="comment"># 跨站请求伪造防止</span></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p>
<figure class="highlight html"><figcaption><span>index.html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Tornado demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'&#123;&#123; static_url("jquery-3.2.0.min.js") &#125;&#125;'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">Hello,World!</div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/index"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"yoyo"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>内容展示<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123; func(nmb) &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;% module custom() %&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">        &#123;% for item in yoyo %&#125;</div><div class="line">            &#123;% if item=='baba' %&#125;</div><div class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">style</span>=<span class="string">"color:red"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">            &#123;% else %&#125;</div><div class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">            &#123;% end %&#125;</div><div class="line">        &#123;% end %&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure>
<p>静态文件的缓存实现 主流做法就是在静态文件的后面加<code>?v=版本号</code>版本号通常是文件的md5校验码的哈希之后的字符串.这样浏览器就可以每次都判断这个静态文件需不需要重新请求</p>
<h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><p>Tornado中可以对cookie进行操作,还可以对cookie进行签名防止伪造<br>要使用签名cookie,可以在settings里配置<code>cookie_secret</code>,然后使用<code>set_secure_cookie</code>和<code>get_secure_cookie</code>去设置和获取签名cookie.<br>关于签名cookie的原理, 其实就是将加密值和原本值加加密key加时间戳的加密值和时间戳拼在一起,服务器端在拿到之后,可以通过解码加密值得到值,再将值和时间戳和本地的加密key拼在一起加密 后与客户端的加密串比较即可.<br><figure class="highlight python"><figcaption><span>cookie.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># cookie操作</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">cookieHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        print(self.cookies)  <span class="comment"># 所有cookie</span></div><div class="line">        self.set_cookie(<span class="string">'yoo'</span>, <span class="string">'biubiu'</span>)  <span class="comment"># 设置cookie</span></div><div class="line">        print(self.get_cookie(<span class="string">'yoo'</span>))  <span class="comment"># 获取指定cookie</span></div><div class="line"></div><div class="line">        name = self.get_argument(<span class="string">'username'</span>)</div><div class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> (<span class="string">'year'</span>, <span class="string">'mika'</span>):</div><div class="line">            self.set_cookie(<span class="string">'username'</span>, name)</div><div class="line">            self.set_secure_cookie(<span class="string">'secureusername'</span>, name)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.write(<span class="string">'请登录'</span>)</div><div class="line"></div></pre></td></tr></table></figure><br>同样在js中也可以操作cookie,jquery.cookie中可以更优雅的操作cookie.<br><figure class="highlight html"><figcaption><span>cookie.html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line">        console.log(document.cookie); //获取所有cookie,是字符串, cookie的特性例如path 过期时间是不包含在内的</div><div class="line">        document.cookie='yoo=666;path=/;'; //设置cookie,同时可以设置path和过期时间</div><div class="line">        function setCookies(key,value,expires) &#123;    //设置cookie并且按秒数设置过期时间</div><div class="line">            var temp=[];</div><div class="line">            var current_date=new Date();</div><div class="line">            current_date.setSeconds(current_date.getSeconds()+5);</div><div class="line">            document.cookie=key+"= "+value+";expires="+current_date.toUTCString(); //cookie的过期时间只接受UTCstring</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //jquery的cookie插件 设置cookie</div><div class="line">        $.cookie('yoo',666,&#123;'path':'/','domain':'','expires':7&#125;)</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure></p>
<h4 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h4><p>CSRF就是cross site request forgery,也就是跨站请求伪造,也就是仿造你网站中某些提交,我自己伪造提交到后台,已达到某种目的.<br>我们这里说CSRF是为了防止我们的网站遭到类似的攻击. Tornado自带了防止csrf的功能<br>首先要在设置里启用这个功能<br><figure class="highlight python"><figcaption><span>setting.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">settings = &#123;</div><div class="line">    <span class="string">"template_path"</span>: <span class="string">"Template"</span>,  <span class="comment"># 模板路径的配置</span></div><div class="line">    <span class="string">"static_path"</span>: <span class="string">"Static"</span>,  <span class="comment"># 必须配置,否者静态文件永远找不到</span></div><div class="line">    <span class="string">"static_url_prefix"</span>: <span class="string">"/biubiu/"</span>,  <span class="comment"># 静态文件路径前缀</span></div><div class="line">    <span class="string">"ui_methods"</span>: md,  <span class="comment"># 配置ui method.</span></div><div class="line">    <span class="string">"ui_modules"</span>: mt,  <span class="comment"># 配置ui module.</span></div><div class="line">    <span class="string">"cookie_secret"</span>: <span class="string">'asdfasdfasdfasdfasdf'</span>,  <span class="comment"># cookie加密</span></div><div class="line">    <span class="string">"xsrf_cookies"</span>: <span class="keyword">True</span>  <span class="comment"># 跨站请求伪造防止</span></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p>
<figure class="highlight python"><figcaption><span>handler.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">csrfHandler</span><span class="params">(baseHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        self.render(<span class="string">'csrf.html'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        self.write(<span class="string">'post'</span>)</div><div class="line"></div></pre></td></tr></table></figure>
<figure class="highlight"><figcaption><span>csrf.html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html lang="en"&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta charset="UTF-8"&gt;</div><div class="line">    &lt;title&gt;csrf&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;form action="/csrf" method="post"&gt;</div><div class="line">        &#123;% raw xsrf_form_html() %&#125;</div><div class="line">        &lt;p&gt;&lt;input name="user" type="text" placeholder="用户名" /&gt;&lt;/p&gt;</div><div class="line">        &lt;p&gt;&lt;input name="pwd" type="password" placeholder="密码" /&gt;&lt;/p&gt;</div><div class="line">        &lt;p&gt;</div><div class="line">            &lt;input name="code" type="text" placeholder="验证码" /&gt;</div><div class="line">            &lt;img id="checkimg" onclick="changeCode();" style="cursor: pointer" src="/checkcode"&gt;</div><div class="line">        &lt;/p&gt;</div><div class="line">        &lt;input type="submit" value="Submit" /&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">    &lt;script src='&#123;&#123; static_url("jquery-3.2.0.min.js") &#125;&#125;'&gt;&lt;/script&gt;</div><div class="line">    &lt;input type="button" value="Ajax_CSRF" onclick="SubmitCsrf();"/&gt;</div><div class="line">    &lt;script&gt;</div><div class="line">        function changeCode() &#123;</div><div class="line">            var code = document.getElementById('checkimg');</div><div class="line">            code.src += '?'</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        function getCookie(name) &#123;</div><div class="line">            var r = document.cookie.match("\\b"+name+"=([^;]*\\b)");</div><div class="line">            return r?r[1]:undefined;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        function SubmitCsrf() &#123;</div><div class="line">            var id = getCookie("_xsrf");</div><div class="line">            $.post(&#123;</div><div class="line">                url:'/csrf',</div><div class="line">                data:&#123;'k1':'v1',"_xsrf":id&#125;,</div><div class="line">                success:function (callback) &#123;</div><div class="line">                    //ajax请求发送成功后自动执行</div><div class="line">                    //callback就是服务器write的数据 post</div><div class="line">                    console.log(callback)</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">        &#125;</div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div><div class="line"></div></pre></td></tr></table></figure>
<p>这里有个梗….我们看到Tornado中用的是xsrf而不是csrf,其实他们指的是一个东西就是跨站请求伪造.当天因为有个同样的安全隐患的简称和csrf冲突了(好像是css的一个安全隐患,简称也是csrf)所以把第一个c改成了x….2333333<br>预防的原理也很简单.我们打开这个功能后,服务器会自动写入一个_xsrf的cookie.我们在提交表单的时候拿到这个值传回,然后服务器会自动比较他们.</p>
<h4 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h4><ol>
<li>用form表单上传..这个最为简单.一个post请求到后台,利用tornado的方法去取到就可以了</li>
<li>AJAX上传,在某些特殊的情况下(当然是老版本ie啦)想异步上传就可以利用iframe来实现<figure class="highlight html"><figcaption><span>fileupload.html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">        &#123;% for item in img_list %&#125;</div><div class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/Static/&#123;&#123;item&#125;&#125;"</span> /&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">        &#123;% end %&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"img"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"fileupload();"</span> &gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/fileupload"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">placeholder</span>=<span class="string">"你的名字"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>爱好<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"favor"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span>篮球:</div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"favor"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"2"</span> /&gt;</span>足球:</div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"favor"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"3"</span> /&gt;</span>乒乓球:</div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"my_form"</span> <span class="attr">name</span>=<span class="string">"form"</span> <span class="attr">action</span>=<span class="string">"/fileupload"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"main"</span> &gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"my_file"</span> <span class="attr">type</span>=<span class="string">"file"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">name</span>=<span class="string">"action"</span> <span class="attr">value</span>=<span class="string">"upload"</span> <span class="attr">onclick</span>=<span class="string">"redirect();"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">"my_iframe"</span> <span class="attr">name</span>=<span class="string">"'my_iframe"</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">style</span>=<span class="string">"display: none"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'&#123;&#123; static_url("jquery-3.2.0.min.js") &#125;&#125;'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line">        function fileupload() &#123;</div><div class="line">            //获取文件对象</div><div class="line">            var fileObj = document.getElementById('img').files[0];</div><div class="line">            var form = new FormData();</div><div class="line">            form.append('name','v1');</div><div class="line">            form.append('file',fileObj);</div><div class="line">            var xhr = new XMLHttpRequest();</div><div class="line">            xhr.open('post','/fileupload',true);</div><div class="line">            xhr.send(form);</div><div class="line">        &#125;</div><div class="line">        function jqfileUpload() &#123;</div><div class="line">            var fileObj = $("#img")[0].files[0];</div><div class="line">            var form = new FormData();</div><div class="line">            form.append('file',fileObj);</div><div class="line">            $.ajax(&#123;</div><div class="line">                type:'post',</div><div class="line">                url:'/fileupload',</div><div class="line">                data:form,</div><div class="line">                processData:false, //告诉jq不要处理数据</div><div class="line">                contentType:false, //告诉jq不要设置contentType</div><div class="line">                success:function (arg) &#123;</div><div class="line">                    console.log(arg);</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        function redirect() &#123;</div><div class="line">            document.getElementById('my_iframe').onload=testt;</div><div class="line">            document.getElementById('my_form').target='my_iframe';</div><div class="line">            document.getElementById('my_form').submit();</div><div class="line">        &#125;</div><div class="line">        function testt(ths) &#123;</div><div class="line">            var t = $('#my_iframe').content.find('body').text();</div><div class="line">            console.log(t);</div><div class="line">        &#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><figcaption><span>lag:python Handler.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#文件上传相关</div><div class="line">IMG_LIST=[]</div><div class="line">class fileuploadHandler(baseHandler):</div><div class="line">    def get(self, *args, **kwargs):</div><div class="line">        self.render(&apos;fileupload.html&apos;,img_list=IMG_LIST)</div><div class="line">    def post(self, *args, **kwargs):</div><div class="line">        import os</div><div class="line">        print(self.get_argument(&apos;name&apos;),None)</div><div class="line">        print(self.get_arguments(&apos;favor&apos;),None)</div><div class="line">        #print(self.get_argument(&apos;file&apos;))</div><div class="line">        file_metas = self.request.files[&apos;name&apos;]</div><div class="line">        for meta in file_metas:</div><div class="line">            file_name = meta[&apos;filename&apos;]</div><div class="line">            with open(os.path.join(&apos;static&apos;,file_name),&apos;wb&apos;) as up:</div><div class="line">                up.write(meta[&apos;body&apos;])</div><div class="line">            IMG_LIST.append(file_name)</div><div class="line"></div></pre></td></tr></table></figure>
<h4 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h4><p>验证码的原理就是后台生成带有随机字符串的图片,然后将内容通过img标签输出到页面.同时将值保存在session中.<br>代码太多..github上看吧…</p>
<h4 id="异步非阻塞"><a href="#异步非阻塞" class="headerlink" title="异步非阻塞"></a>异步非阻塞</h4><p>坑太大…回头再填吧…</p>
<hr>
<h3 id="自定义Web组件"><a href="#自定义Web组件" class="headerlink" title="自定义Web组件"></a>自定义Web组件</h3><h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p>首先Session这个东西,,很多Web框架都在用,并且自带实现,但是Tornado是一个轻量级框架,并没有实现Session这个东西.<br>Session是基于cookie实现的,原理是只需要在客户端的cookie上存储一个sessionID,这个唯一ID标识了服务器上的一块存储区域,里面有和该客户交互所需的各种各样的信息.<br>Session在服务器端的存储是门艺术,有的简单粗暴直接存内存,有的用分布式,有的启用缓存…<br>我们要实现Session组件的目标是,可以无缝的简单粗暴的使用session类似下面这样    <strong>面向对象的思想去实现</strong><br><figure class="highlight python"><figcaption><span>sessionHandelr.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># session 操作</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">sessionHandler</span><span class="params">(baseHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> self.get_argument(<span class="string">'username'</span>, <span class="keyword">None</span>) <span class="keyword">in</span> [<span class="string">'year'</span>, <span class="string">'mika'</span>]:</div><div class="line">            self.session[<span class="string">'is_login'</span>] = <span class="keyword">True</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.write(<span class="string">'请登录'</span>)</div><div class="line"></div></pre></td></tr></table></figure><br>我们看到 只需要调用 <code>self.session[]</code>就可以轻松的放置和取出session中的数据<br>首先我们要有一个baseHandler类供我们以后的Handler类继承,在这个类里面,我们要做一些简单的初始化操作,比如初始化一个我们的Session类对象.<br><figure class="highlight python"><figcaption><span>baseHaandler</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">baseHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self)</span>:</span></div><div class="line">        self.session = Session(self)</div></pre></td></tr></table></figure><br>接下来就是我们的Session类了,,想要像字典一样去调用我们需要用到<code>__setitem__</code>和<code>__getitem__</code>,剩下的无非就是生成随机sessionID和判断是否有SessionID的问题了<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, handler)</span>:</span></div><div class="line">        self.handler = handler</div><div class="line">        self.random_str = <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get_random_str</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">import</span> hashlib</div><div class="line">        <span class="keyword">import</span> time</div><div class="line">        obj = hashlib.md5()</div><div class="line">        obj.update(bytes(str(time.time()), encoding=<span class="string">'utf-8'</span>))</div><div class="line">        random_str = obj.hexdigest()</div><div class="line">        <span class="keyword">return</span> random_str</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.random_str:</div><div class="line">            random_str = self.handler.get_cookie(<span class="string">'__biubiu__'</span>, <span class="keyword">None</span>)</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> random_str:</div><div class="line">                random_str = self.__get_random_str()</div><div class="line">                SESSION[random_str] = &#123;&#125;</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">if</span> random_str <span class="keyword">in</span> SESSION.keys():</div><div class="line">                    <span class="keyword">pass</span></div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    random_str = self.__get_random_str()</div><div class="line">                    SESSION[random_str] = &#123;&#125;</div><div class="line">            self.random_str = random_str</div><div class="line">        SESSION[self.random_str][key] = value</div><div class="line">        self.handler.set_cookie(<span class="string">'__biubiu__'</span>, self.random_str)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></div><div class="line">        random_str = self.handler.get_cookie(<span class="string">'__biubiu__'</span>, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> random_str:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        usr_info_dict = SESSION.get(random_str, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> usr_info_dict:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        value = usr_info_dict.get(key, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">return</span> value</div><div class="line"></div></pre></td></tr></table></figure></p>
<h4 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h4><p>表单验证是所有Web程序都绕不开的问题了,因为前端的验证是可以跳过的,所以后端的验证是必不可少的<br>我们这里实现表单验证,同样要用<strong>面向对象的思想</strong><br>我们的目的是我们后台验证表单的时候只需要调用我们穿件的一个前台Form的对应后台对象的验证方法就可以完成所有的验证并拿到结果<br><figure class="highlight python"><figcaption><span>checkFormHandler</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">checkFormHandler</span><span class="params">(baseHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        self.render(<span class="string">"checkForm.html"</span>,error_dict=<span class="keyword">None</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        files=self.request.files.get(<span class="string">'file'</span>,[])</div><div class="line"></div><div class="line">        obj=IndexForm()</div><div class="line">        is_valid,success_dict,error_dict=obj.check_valid(self)</div><div class="line">        <span class="keyword">if</span> is_valid:</div><div class="line">            print(<span class="string">'success'</span>,success_dict)</div><div class="line">            obj.file.save()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">'error'</span>,error_dict)</div><div class="line">            self.render(<span class="string">'checkForm.html'</span>,error_dict=error_dict)</div></pre></td></tr></table></figure><br>我们在创建前台Form的对应后台类的时候只需要在后台类中将对应的字段类添加进来就可以,,例如我要输入一个ip,一个爱好,一个文件上传,在创建这些字段的时候我们可以自定义是否必填,和格式错误提示语等等自定义内容.<br><figure class="highlight python"><figcaption><span>indexForm.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexForm</span><span class="params">(BaseForm)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.ip=IPFiled(required=<span class="keyword">True</span>,error_dict=&#123;<span class="string">'required'</span>:<span class="string">'不能填空啊'</span>&#125;)</div><div class="line">        self.favor = checkboxFiled(required=<span class="keyword">True</span>, error_dict=&#123;<span class="string">'required'</span>: <span class="string">'不能填空啊'</span>&#125;)</div><div class="line">        self.file=fileFiled(required=<span class="keyword">True</span>, error_dict=&#123;<span class="string">'required'</span>: <span class="string">'不能填空啊'</span>&#125;)</div></pre></td></tr></table></figure><br>这个对应Form类有一个父类,里面有验证的方法,验证方法就循环调用内部变量的验证方法.<br><figure class="highlight python"><figcaption><span>baseForm.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseForm</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_valid</span><span class="params">(self,handle)</span>:</span></div><div class="line">        flag=<span class="keyword">True</span></div><div class="line">        value_dict=&#123;&#125;</div><div class="line">        error_message_dict=&#123;&#125;</div><div class="line">        success_value_dict=&#123;&#125;</div><div class="line">        <span class="keyword">for</span> key,regular <span class="keyword">in</span> self.__dict__.items():</div><div class="line">            <span class="keyword">if</span> type(regular)==checkboxFiled:</div><div class="line">                input_value=handle.get_arguments(key)</div><div class="line">            <span class="keyword">elif</span> type(regular)==fileFiled :</div><div class="line">                <span class="comment">#获取文件名</span></div><div class="line">                file_list=handle.request.files.get(key)</div><div class="line">                input_value=[]</div><div class="line">                <span class="keyword">for</span> item <span class="keyword">in</span> file_list:</div><div class="line">                    input_value.append(item[<span class="string">'filename'</span>])</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                input_value=handle.get_argument(key)</div><div class="line">            regular.validate(key,input_value)</div><div class="line">            <span class="keyword">if</span> regular.is_valid:</div><div class="line">                success_value_dict[key]=regular.value</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                flag=<span class="keyword">False</span></div><div class="line">                error_message_dict[key]=regular.error</div><div class="line"></div><div class="line">            value_dict[key]=input_value</div><div class="line">        <span class="keyword">return</span> flag,success_value_dict,error_message_dict</div></pre></td></tr></table></figure><br>剩下来就是各个字段的类定义,里面有各个字段的验证方法.<br><figure class="highlight python"><figcaption><span>Filed.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IPFiled</span>:</span></div><div class="line">    REGULAR=<span class="string">""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,error_dict=None,required=True)</span>:</span></div><div class="line">        self.error_dict=&#123;&#125;</div><div class="line">        <span class="keyword">if</span> error_dict:</div><div class="line">            self.error_dict.update(error_dict)</div><div class="line">        self.required=required</div><div class="line">        self.error=<span class="keyword">None</span></div><div class="line">        self.is_valid=<span class="keyword">False</span></div><div class="line">        self.value=<span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validata</span><span class="params">(self,name,input_vale)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.required:</div><div class="line">            self.is_valid=<span class="keyword">True</span></div><div class="line">            self.value=input_vale</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> input_vale.strip():</div><div class="line">                <span class="keyword">if</span> self.error_dict.get(<span class="string">'required'</span>,<span class="keyword">None</span>):</div><div class="line">                    self.error=self.error_dict[<span class="string">'required'</span>]</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    self.error=<span class="string">"%s is required"</span> % name</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                ret=re.match(self.REGULAR,input_vale)</div><div class="line">                <span class="keyword">if</span> ret:</div><div class="line">                    self.is_valid=<span class="keyword">True</span></div><div class="line">                    self.value=ret.group()</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    <span class="keyword">if</span> self.error_dict.get(<span class="string">'valid'</span>,<span class="keyword">None</span>):</div><div class="line">                        self.error=self.error_dict[<span class="string">'valid'</span>]</div><div class="line">                    <span class="keyword">else</span>:</div><div class="line">                        self.error=<span class="string">"%s valid is wrong"</span> % name</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">checkboxFiled</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,error_dict=None,required=True)</span>:</span></div><div class="line">        self.error_dict = &#123;&#125;</div><div class="line">        <span class="keyword">if</span> error_dict:</div><div class="line">            self.error_dict.update(error_dict)</div><div class="line">        self.required = required</div><div class="line">        self.error = <span class="keyword">None</span></div><div class="line">        self.is_valid = <span class="keyword">False</span></div><div class="line">        self.value = <span class="keyword">None</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validata</span><span class="params">(self,name,input_value)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.required:</div><div class="line">            self.is_valid=<span class="keyword">True</span></div><div class="line">            self.value=input_value</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> input_value:</div><div class="line">                <span class="keyword">if</span> self.error_dict.get(<span class="string">'required'</span>,<span class="keyword">None</span>):</div><div class="line">                    self.error=self.error_dict[<span class="string">'required'</span>]</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    self.error=<span class="string">"%s is required"</span> % name</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                self.is_valid = <span class="keyword">True</span></div><div class="line">                self.value = input_value</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">fileFiled</span>:</span></div><div class="line">    REGULAR = <span class="string">""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,error_dict=None,required=True)</span>:</span></div><div class="line">        self.error_dict = &#123;&#125;</div><div class="line">        <span class="keyword">if</span> error_dict:</div><div class="line">            self.error_dict.update(error_dict)</div><div class="line">        self.required = required</div><div class="line">        self.error = <span class="keyword">None</span></div><div class="line">        self.is_valid = <span class="keyword">False</span></div><div class="line">        self.value = <span class="keyword">None</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validata</span><span class="params">(self,name,all_file_name_list)</span>:</span></div><div class="line">        self.name=name</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.required:</div><div class="line">            self.is_valid=<span class="keyword">True</span></div><div class="line">            self.value=all_file_name_list</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> all_file_name_list:</div><div class="line">                self.is_valid=<span class="keyword">False</span></div><div class="line">                <span class="keyword">if</span> self.error_dict.get(<span class="string">'required'</span>,<span class="keyword">None</span>):</div><div class="line">                    self.error=self.error_dict[<span class="string">'required'</span>]</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    self.error=<span class="string">"%s is required"</span> % name</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">for</span> file_name <span class="keyword">in</span> all_file_name_list:</div><div class="line">                    ret = re.match(self.REGULAR, file_name)</div><div class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> ret:</div><div class="line">                        self.is_valid=<span class="keyword">False</span></div><div class="line">                        <span class="keyword">if</span> self.error_dict.get(<span class="string">'valid'</span>, <span class="keyword">None</span>):</div><div class="line">                            self.error = self.error_dict[<span class="string">'valid'</span>]</div><div class="line">                        <span class="keyword">else</span>:</div><div class="line">                            self.error = <span class="string">"%s valid is wrong"</span> % name</div><div class="line">                        <span class="keyword">break</span></div><div class="line">                    <span class="keyword">else</span>:</div><div class="line">                        self.value.append(file_name)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self,request)</span>:</span></div><div class="line">        file_metas = request.files.get(self.name)</div><div class="line">        <span class="keyword">for</span> meta <span class="keyword">in</span> file_metas:</div><div class="line">            file_name = meta[<span class="string">'filename'</span>]</div><div class="line">            <span class="keyword">with</span> open(os.path.join(<span class="string">'static'</span>, file_name), <span class="string">'wb'</span>) <span class="keyword">as</span> up:</div><div class="line">                up.write(meta[<span class="string">'body'</span>])</div><div class="line">            IMG_LIST.append(file_name)</div></pre></td></tr></table></figure></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>扫着玩~~</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/img/QR.jpg" alt="YEAR WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Python/" rel="tag"># Python</a>
          
            <a href="/tags/WEB/" rel="tag"># WEB</a>
          
            <a href="/tags/框架/" rel="tag"># 框架</a>
          
            <a href="/tags/Tornado/" rel="tag"># Tornado</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/04/玩蛇笔记WEB篇之什么是WEB框架/" rel="next" title="玩蛇笔记WEB篇之什么是WEB框架">
                <i class="fa fa-chevron-left"></i> 玩蛇笔记WEB篇之什么是WEB框架
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/08/08/玩蛇笔记SQL篇之Mysql/" rel="prev" title="玩蛇笔记SQL篇之Mysql">
                玩蛇笔记SQL篇之Mysql <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/07/06/玩蛇笔记WEB篇之Tornado/"
           data-title="玩蛇笔记WEB篇之Tornado" data-url="https://TakeEasy.github.io/2017/07/06/玩蛇笔记WEB篇之Tornado/">
      </div>
    
    <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "1243a24c6de1460d910bb72c3d9397dd",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/img/touxiang.jpg"
               alt="YEAR" />
          <p class="site-author-name" itemprop="name">YEAR</p>
           
              <p class="site-description motion-element" itemprop="description">行则将至</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/TakeEasy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#框架使用"><span class="nav-number">2.</span> <span class="nav-text">框架使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#快速开始"><span class="nav-number">2.1.</span> <span class="nav-text">快速开始</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#路由系统"><span class="nav-number">2.2.</span> <span class="nav-text">路由系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模板引擎"><span class="nav-number">2.3.</span> <span class="nav-text">模板引擎</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#静态文件"><span class="nav-number">2.4.</span> <span class="nav-text">静态文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cookie"><span class="nav-number">2.5.</span> <span class="nav-text">Cookie</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CSRF"><span class="nav-number">2.6.</span> <span class="nav-text">CSRF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#上传文件"><span class="nav-number">2.7.</span> <span class="nav-text">上传文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证码"><span class="nav-number">2.8.</span> <span class="nav-text">验证码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#异步非阻塞"><span class="nav-number">2.9.</span> <span class="nav-text">异步非阻塞</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义Web组件"><span class="nav-number">3.</span> <span class="nav-text">自定义Web组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Session"><span class="nav-number">3.1.</span> <span class="nav-text">Session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#表单验证"><span class="nav-number">3.2.</span> <span class="nav-text">表单验证</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YEAR</span>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"yearblog"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  
















  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("wJSzMht9jhmY1dOMTNb4xd7K-gzGzoHsz", "Dng0OEp5yP5twrLIJIA0Wx7x");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

</body>
</html>
