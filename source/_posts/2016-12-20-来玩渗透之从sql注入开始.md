---
title: 来玩渗透之从sql注入开始
date: 2016-12-20 15:24:51
categories:
- WEB安全
- 渗透测试
- 数据库
tags:
- SQL注入
---
{% cq %} 不将就的人终将取得成功 {% endcq %}
{% fi /img/13.jpg, ..., Python %}
<!-- more -->
> WEB安全从渗透开始,渗透从sql注入开始.
> 持续更新...

------

### asp+access的注入
+ 此类的注入会比较常见,access为微软的一个极轻量级的数据库(如果网站大概有1000人使用就会受不了),这种组合常见于一些中小型企业用来做门面网站,所以通常也没有什么安全防护,到了当今这个时代,通常会被各种防火墙保护,什么安全狗,360,waf.
+ 通常步骤是判断注入点,猜解表名,猜解列名,猜解数据.
+ 由于access的简单结构,没有表记录所有的表名列名,所以access的注入方法都为暴力拆解

#### 判断注入
+ 首先页面本身要是动态的,有数据流的交互才会产生注入点,比较显示像`?id=1`这种结尾的,后台会接收id参数,然后去数据库查询,随着技术发展,会对url进行优化,例如`/artical/1`有可能后面那个1会是id参数.
+ 找到疑似注入点,就可以通过在url后添加`'`,` and 1=1`,` and 1=2`根据页面反应来判断是否存在注入点或者注入点被防火墙拦截.

#### 联合查询
1. 有了注入点后,在存在注入点的url后添加类似` order by 6`,通过排序的sql语法来试探当前查询表的列数,例如`order by 21`没有报错`order by 22`报错,这意味着不存在第22列存在21列,所以当前表有21列.
2. 知道当前表有21列之后就可以用`union`大法了,在url后添加` union select 1,2,3....,22 from admin`来试表名,因为我们要拿权限拿后台,所以要拿到存有管理员账号密码的表,此类表通常会命名为admin之类,但具体叫什么只能去试,用工具从字典里批量去试比较靠谱.
3. 在使用`union`的同时可以观察页面是否有出现`select 1,2,3,4,...,22`之间的值,如果有就是曝列的大好消息,例如页面上原本出现标题或者内容的地方出现3,5就说明第三列和第5列被曝出来了
4. 利用3,5被曝,我们就可以利用这两列去猜解列名,例如` union select 1,2,username,4,password,6,...,21 from admin`如果admin表存在username和password列则会把这两列的值直接曝在页面上.

#### 逐字拆解
1. 前面说过由于access的简单结构只能暴力拆解,逐字拆解可以在知道表名列名切页面没有曝数据的情况下逐字的拆解数据,首先通过添加` and exists(select * from admin)`来猜出表名,通过` and exists(select username from admin)`来猜解出列名.
2. 有了表名和列名,我们先要知道数据的长度再进行接下来的逐字才猜解,通过` and (select top 1 len(username) from admin)=5`来判断长度
3. 有了长度,就可以通过指定数据指定位数的字符的ascii码来判断该字符是什么,通常sql注入工具就喜欢这种方式,添加` and (select top 1 asc(mid(username,1,1)) from admin)=97`来逐字猜解内容.

#### 注入时表名,列名无法获取
+ 无法获取表名时用社工学,对比网站url地址.
+ 无法获取列名时可以采用偏移注入,社工学,对比参数名

#### 偏移注入
+ 当表名知道,列名无法获取的时候使用
+ 用`*`代替字符,可以计算出`*`代替字符的位数,例如添加` union select 1,2,3....,12,* from admin`,也就是表的列数.
+ 后可以用`from(admin as a inner join admin as b on a.id=b.id)`,这样`*`就代表2倍的列数,利用这,可以偏移曝出admin内的某列的字段内容.
+ 例如`1,2,3,4,5,....,22`曝出的字段是5和16,列数是6当`*`为12时,22-12=10,用`1,2,3,...,10,*`可以曝出第6列的内容.

#### 有待后续更新...

------

### php+mysql的注入
+ php是现在WEB开发技术的巨头,mysql应该是免费数据中最强的关系型数据库,这俩货绝对是黄金搭档.
+ 注入步骤上不同于access,因为mysql会多出一层数据库,因为一个mysql服务中会存在多个shujuku来服务于多个web项目,好在mysql5.0以上拥有Information_shcema这个数据库,会记录所有数据库里的表名列名等等信息,可以告别暴力猜解啦

#### 注入流程
1. 判断注入,同access,这个没什么好说的了
2. 添加`order by`来判断当前查询表的列数,为了后面的流程准备.
3. 通过`union select 1,2,3 from admin`暴力猜解表名,也可以先通过`union select database(),version,user(),@@version_compile_os` 来分别得出数据库名,数据库版本,当前数据库用户,服务器系统版本,为后面的有根据的注入来服务.
4. 通过`union select table_name,2,3 from information.tables where table_schema=数据库名的十六进制`可以得到指定数据库下所有表名,`information.tables`里会存储整个mysql里所有表信息.
5. 通过` union select Column_name,2,3 from information_schema.columns where table_name=指定表名的十六进制表示`可以根据指定表名来获取该表的所有列名,`information_schema.Columns`会存有整个mysql里所有列名的信息.
6. 有了表名列名剩下的就简单了`union select 列名,2,3 from 表名`搞定.

#### mysql的用户权限和上传读取文件
+ mysql中的mysql数据库中有user表,里面记录者所有mysql用户和对应每项操作的权限,我们可以根据注入点得到当前站点使用的mysql用户,就可以得知该用户是否有权限进行文件读取上传等等操作.
+ 如果有读取权限则可以用` union select load_file(指定文件路径),2,3`.可用于获取敏感文件的内容.
+ 如果有写入文件权限则可以用 `union select '文件内容' into outfile '指定文件路径`.可上传后门,一句话木马,**注意** 单引号闭合问题 可以将文件内容用**十六进制**编码代替,路径别用反斜杠.
+ 如果能有文件读取和写入的权限,自然要知道网站服务器的目录结构,也就是获取网站路径的获取.

    1. 网站曝出显示,php.ini 中display_errors默认是打开的,利用注入点报错就可以在当前页面获取页面路径.
    2. phpcms曝路径,如果知道别人用的cms是哪一个,就可以百度一下看这种cms如何曝路径
    3. 调试页面曝路径, phpinfo(),网站开发人员通常会搞个这个页面去方便调试网站,可以用工具去批量扫一下看有没有如此网页遗留.
    4. 读取配置文件,对应服务器配置文件所在位置,,前提是要有读取权限.
    5. 社工学,盲猜目录或者谷歌黑客.
    6. 注意符号问题用`/`或者`\\`,当写入文件内容的时候,内容有`'`的时候将内容转换成**十六进制**写入.

#### 完善注入的完整度
+ 跨库注入,通过网站的注入点跨库注入在同一个mysql下另一个网站的数据库,前提是获得的mysql账号权限足够大.
+ 善于使用抓包工具对常用sql注入工具进行抓包,然后可以分析工具所用的sql语句,就可以知道sql渗透的原理,例如``= 999999.9 union all select (select distinct concat(0x7e,0x27,unhex(Hex(cast(schema_name as char))),0x27,0x7e) from `information_schema`.schemata limit 14,1),0x31303235343830303536,0x31303235343830303536``就可以依次获取其他数据库的名字,``= 999999.9 union all select (select concat(0x7e,0x27,unhex(Hex(cast(group_concat(table_name) as char))),0x27,0x7e) from `information_schema`.tables where table_schema=0x6874747073716C696E),0x31303235343830303536,0x31303235343830303536``可获取指定数据库的表名信息.多抓包,多理解原理.

#### mysql的防注入转义
+ 魔术引号的开启,php.ini中magic_quotes_gpc开启所有的`'`,`"`,`\`和NULL字符都会被自动加上反斜杠作为转译.
+ 使用addslashes函数对字符串进行转译,效果同上.
+ 对于这种防注入可以采用宽字节注入,但具体要怎么绕过要根据实际情况来灵活运用.
+ 编码注入,,在mysql里用十六进制编码可以不需要单引号直接上内容就可以达到绕过防注入转译

#### 三种参数型注入方式
1. 数字型,后台sql类似`Select * from news where id=1`.
2. 字符型,后台sql类似`Select * from news where name=’year’`.
3. 搜索型,后台sql类似`Select * from news where name like ‘%year%’ order by username`.
+ 闭合引号,并且善用`-- // /**/`等sql注释符,去注释掉后面的语句.例如`Select * from news where name=’year’ order by 2--'`,总之关键在于如何闭合字符如何使后台产生的sql达到我们想要的效果

#### 提交注入
+ post注入,主要用于用户输入表单提交,内容会在http请求的下面,通过抓包才能看的到.可以添加诸如`' or 1=1/*`这种万能密码注入,来达到登录网站的目的.
+ cookie注入,主要是人家网站后台从cookie中取数据,这样我们抓包,然后在cookie中加入数据,完成注入.
+ 有的php网站用`_REQUEST['']`方式来获取所有参数,但可能对某一种或者两种参数进行了过滤,我们可以通过剩下的方式来达成注入的目的.
+ http头注入,有的网站会通过拿到http头内容里的参数来做一些适配,比如访问主机的浏览器内核,屏幕分辨率等等,例如php里的`$_SERVER['']`可以拿到这些信息,如果网站要利用这些信息进行查询操作的话,这就成为了很好的注入点,我们修改http头里面的内容就可以达到注入的效果了.

#### 同源和非同源
+ http头中有一个REFERER值是链接到当前页面的前一个页面的URL地址,在php中可以用`$_SERVER['HTTP_REFERER']`来获取.
+ 举个简单的例子,向某人付款的链接是`www.pay.com?money=9999&card=12345678`,而我创建一个钓鱼网站`www.diaoyu.com`,首页插入引用网站`www.pay.com?money=9999&card=12345678`,这样只要受害人访问了我的钓鱼网站就会自动发出引用URL的请求,这就形成了**跨站点请求伪造**也就是**csrf**.
+ 同源策略就这样诞生了,在访问`www.pay.com?money=9999&card=12345678`会检测请求是否来自于同源的网站,如果非同源则会拒绝掉这个请求.具体的同源规则后续补充.

#### 注入的编码问题
+ 注入时要注意参数是否是编码后的,常见的如base64编码

------

### 注入绕过
+ 绕过的方法取决于被注入网站的过滤方法,这样才能对症下药.
+ 大小写绕过,字符编码绕过,提交绕过,字符添加绕过.....
+ 主要要自己研究,自己搭建本地安全狗之类的环境慢慢测试吧..
+ 主要几个方面,注入,上传,扫描,后门,下载,控制.其中注入和上传难度大要研究,后门难度一般,有办法,后门难度较大有办法,扫描,表面绕过,难度较大复杂,下载,没办法